#!/usr/bin/bash
if [ -z ${XDG_DATA_HOME} ]; then
  echo "Required environment variables unset -- re-login to load pam env"
  exit 1
fi

cd "$HOME" || exit

# Update submodules
echo "Initializing submodules..."
yadm submodule update --recursive --init

# Sparse checkout
echo "Editing yadm gitconfig..."
echo "Using sparse checkout..."
yadm gitconfig core.sparseCheckout true
cat <<EOF >"$XDG_CONFIG_HOME/yadm/repo.git/info/sparse-checkout"
# generated by $0
/*
!README.md
EOF
yadm checkout --quiet

# Make file directories
echo "Creating file directories..."
files_dirs=(documents downloads games images lfs music programming share tmp)
mkdir -p "$HOME/files"
for dir in "${file_dirs[@]}"; do
  mkdir "$HOME/files/$dir"
done

# Create some necessary directories
function create_dir() {
  echo "Creating directory $1..."
  mkdir -p $1
}

create_dir "$XDG_CACHE_HOME/less"
create_dir "$XDG_DATA_HOME/wine/pfx/default"

# Bootstrap neovim
echo "Bootstrapping neovim..."
nvim_bootstrap="$XDG_CONFIG_HOME/nvim/bootstrap"
if [ -f "$nvim_bootstrap" ]; then
  $nvim_bootstrap
fi

# Bootstrap steam
echo "Bootstrapping Steam..."
steam_skins_dir="$XDG_DATA_HOME/Steam/skins"
create_dir "$steam_skins_dir"
steam_skins_metro_zip="$steam_skins_dir/metro-for-steam-4.4.zip"
steam_skins_metro_dir="$steam_skins_dir/metro-for-steam-4.4"
echo "Downloading metro-for-steam..."
wget -O "$steam_skins_metro_zip" "https://github.com/minischetti/metro-for-steam/archive/v4.4.zip"
echo "Decompressing metro-for-steam"
unzip -o "$steam_skins_metro_zip" -d "$steam_skins_dir"
rm "$steam_skins_metro_zip"

steam_skins_metro_patch="$XDG_DATA_HOME/Steam/skins/metro-for-steam-4.4-patch"
echo "Downloading patch for metro-for-steam..."
git clone "https://github.com/redsigma/UPMetroSkin.git" "$steam_skins_metro_patch"
echo "Patching metro-for-steam..."
cp -r "$steam_skins_metro_patch/Unofficial 4.x Patch/Main Files [Install First]"/* "$steam_skins_metro_dir/"
rm -rf "$steam_skins_metro_patch"
